generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  TECH
  OFFICE
  OWNER
}

enum JobType {
  INSURANCE
  CUSTOMER_PAY
  MIXED
  TOW_STORAGE
}

enum JobStatus {
  DRAFT
  ESTIMATE_READY
  SENT_TO_INSURANCE
  WAITING_APPROVAL
  APPROVED
  IN_REPAIR
  COMPLETE
  DELIVERED
  CLOSED
}

enum EstimateCategory {
  LABOR
  PARTS
  MATERIALS
  SUBLET
  FEE
  STORAGE
  TAX
  DISCOUNT
}

enum LaborType {
  BODY
  PAINT
  MECH
  DETAIL
}

enum DocumentType {
  ESTIMATE_PDF
  INSURANCE_PACKET
  AUTH_SIGNED
  LIEN_NOTICE
  LIEN_PACKET
  INVOICE
  OTHER
}

enum AuthorizationType {
  REPAIR_AUTH
  DIRECTION_TO_PAY
  STORAGE_AUTH
  TEARDOWN_AUTH
}

enum PayerType {
  INSURANCE
  CUSTOMER
}

enum PaymentMethod {
  CASH
  CHECK
  CARD
  OTHER
}

enum StorageApplies {
  ALL
  TOW_STORAGE_ONLY
  UNPAID_ONLY
}

enum LienStatus {
  NONE
  WATCH
  NOTICE_READY
  NOTICE_SENT
  FILE_READY
  FILED
  RESOLVED
}

enum TaskType {
  FOLLOW_UP_ADJUSTER
  FOLLOW_UP_CUSTOMER
  COLLECT_DEDUCTIBLE
  SEND_NOTICE
  OTHER
}

model User {
  id           String     @id @default(cuid())
  name         String
  email        String     @unique
  passwordHash String
  role         Role
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt

  assignedTasks Task[]    @relation("TaskAssignee")
  auditLogs     AuditLog[]
  sessions      Session[]
  magicTokens   MagicLinkToken[]
}

model Session {
  id        String   @id @default(cuid())
  userId    String
  tokenHash String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model MagicLinkToken {
  id        String   @id @default(cuid())
  userId    String
  tokenHash String   @unique
  expiresAt DateTime
  usedAt    DateTime?
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Customer {
  id        String    @id @default(cuid())
  name      String
  phone     String
  email     String
  address   String?
  createdAt DateTime  @default(now())

  vehicles Vehicle[]
  jobs     Job[]
}

model Vehicle {
  id        String   @id @default(cuid())
  vin       String?
  year      Int
  make      String
  model     String
  trim      String?
  mileage   Int?
  customerId String
  createdAt DateTime @default(now())

  customer Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)
  jobs     Job[]
}

model Job {
  id            String    @id @default(cuid())
  jobNumber     String    @unique
  customerId    String
  vehicleId     String
  jobType       JobType
  status        JobStatus
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  promisedDate  DateTime?
  completedDate DateTime?
  deliveredDate DateTime?
  notesInternal String?
  notesCustomer String?
  storageStartDate DateTime?

  customer      Customer  @relation(fields: [customerId], references: [id], onDelete: Cascade)
  vehicle       Vehicle   @relation(fields: [vehicleId], references: [id], onDelete: Cascade)
  claim         Claim?
  estimate      Estimate?
  photos        Photo[]
  documents     Document[]
  authorizations Authorization[]
  payments      PaymentLedgerEntry[]
  storageAccrual StorageAccrual?
  lienCase      LienCase?
  tasks         Task[]
  auditLogs     AuditLog[]
}

model Claim {
  id                String   @id @default(cuid())
  jobId             String   @unique
  carrierName       String
  claimNumber       String
  adjusterName      String?
  adjusterEmail     String?
  adjusterPhone     String?
  dateSent          DateTime?
  lastFollowUpAt    DateTime?
  nextFollowUpAt    DateTime?
  approvedAmountCents Int?
  shortPayCents     Int?
  createdAt         DateTime @default(now())

  job Job @relation(fields: [jobId], references: [id], onDelete: Cascade)
}

model Estimate {
  id                     String   @id @default(cuid())
  jobId                  String   @unique
  bodyLaborRateCents     Int
  paintLaborRateCents    Int
  mechLaborRateCents     Int
  detailLaborRateCents   Int
  partsMarkupRuleJson    Json
  subletMarkupPercent    Float
  materialsFormulaJson   Json
  taxRatePercent         Float?
  totalWrittenCents      Int
  totalApprovedCents     Int?
  internalMarginPercent  Float?
  createdAt              DateTime @default(now())
  updatedAt              DateTime @updatedAt

  job Job @relation(fields: [jobId], references: [id], onDelete: Cascade)
  lineItems EstimateLineItem[]
}

model EstimateLineItem {
  id              String           @id @default(cuid())
  estimateId      String
  category        EstimateCategory
  description     String
  quantity        Float
  unit            String
  unitCostCents   Int?
  unitPriceCents  Int?
  laborHours      Float?
  laborType       LaborType?
  isCustomerFacing Boolean         @default(true)
  sortOrder       Int
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt

  estimate Estimate @relation(fields: [estimateId], references: [id], onDelete: Cascade)
}

model Photo {
  id        String   @id @default(cuid())
  jobId      String
  url       String
  caption   String?
  tagPanel  String?
  createdAt DateTime @default(now())

  job Job @relation(fields: [jobId], references: [id], onDelete: Cascade)
}

model Document {
  id        String      @id @default(cuid())
  jobId     String
  type      DocumentType
  url       String
  createdAt DateTime    @default(now())

  job Job @relation(fields: [jobId], references: [id], onDelete: Cascade)
}

model Authorization {
  id               String            @id @default(cuid())
  jobId            String
  type             AuthorizationType
  signerName       String
  signerEmail      String?
  signatureImageUrl String?
  signatureTyped   String?
  signedAt         DateTime
  signerIp         String
  signerUserAgent  String
  pdfUrl           String
  createdAt        DateTime          @default(now())

  job Job @relation(fields: [jobId], references: [id], onDelete: Cascade)
}

model PaymentLedgerEntry {
  id         String        @id @default(cuid())
  jobId      String
  payerType  PayerType
  method     PaymentMethod
  amountCents Int
  reference  String?
  receivedAt DateTime
  note       String?
  createdAt  DateTime      @default(now())

  job Job @relation(fields: [jobId], references: [id], onDelete: Cascade)
}

model StoragePolicy {
  id                 String        @id @default(cuid())
  name               String
  dailyRateCents     Int
  graceDays          Int
  indoorDailyRateCents Int?
  applies            StorageApplies
  createdAt          DateTime      @default(now())
}

model StorageAccrual {
  id               String   @id @default(cuid())
  jobId            String   @unique
  startDate        DateTime
  endDate          DateTime?
  dailyRateCents   Int
  totalAccruedCents Int
  updatedAt        DateTime @updatedAt

  job Job @relation(fields: [jobId], references: [id], onDelete: Cascade)
}

model LienCase {
  id                     String    @id @default(cuid())
  jobId                  String    @unique
  status                 LienStatus
  riskReason             String?
  noticeSentAt           DateTime?
  certifiedMailTracking  String?
  filingDate             DateTime?
  createdAt              DateTime  @default(now())
  updatedAt              DateTime  @updatedAt

  job Job @relation(fields: [jobId], references: [id], onDelete: Cascade)
}

model Task {
  id               String    @id @default(cuid())
  jobId            String
  type             TaskType
  dueAt            DateTime
  completedAt      DateTime?
  assignedToUserId String?
  note             String?
  createdAt        DateTime  @default(now())

  job Job @relation(fields: [jobId], references: [id], onDelete: Cascade)
  assignedTo User? @relation("TaskAssignee", fields: [assignedToUserId], references: [id], onDelete: SetNull)
}

model AuditLog {
  id          String   @id @default(cuid())
  jobId       String?
  actorUserId String
  action      String
  beforeJson  Json?
  afterJson   Json?
  createdAt   DateTime @default(now())

  job   Job? @relation(fields: [jobId], references: [id], onDelete: SetNull)
  actor User @relation(fields: [actorUserId], references: [id], onDelete: Cascade)
}

model ShopSettings {
  id                       String   @id @default("default")
  shopName                 String   @default("BodyShop Quote & Lien")
  defaultBodyLaborRateCents Int
  defaultPaintLaborRateCents Int
  defaultMechLaborRateCents Int
  defaultDetailLaborRateCents Int
  partsMarkupRuleJson      Json
  subletMarkupPercent      Float
  materialsFormulaJson     Json
  defaultShopFeesJson      Json
  defaultTaxRatePercent    Float
  storagePolicyDefaultsJson Json
  lienFlagRulesJson        Json
  releaseControlEnabled    Boolean  @default(true)
  createdAt                DateTime @default(now())
  updatedAt                DateTime @updatedAt
}
